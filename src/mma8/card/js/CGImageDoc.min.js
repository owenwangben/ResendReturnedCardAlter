/*
 * CGImageDoc.js
 * http://www.changingtec.com
 *
 * Copyright 2018 全景軟體股份有限公司
*/
var kcViewCtrl, kcViewCtrl2;
var canvasOrig, canvasOrig2;
var canvasConvert;
String.prototype.format=function(){a=this;for(k in arguments)a=a.replace(new RegExp("\\{"+k+"\\}","g"),arguments[k]);return a};var cgimg=cgimg||function(){function a(a){var b=a.width,c=a.height,d=document.createElement("canvas");d.width=b,d.height=c;var e=d.getContext("2d");e.fillStyle="rgb(0,255,0)",e.strokeStyle="rgb(0,255,0)",e.drawImage(a,0,0,b,c);var f=e.getImageData(0,0,b,c),g=new jsfeat.matrix_t(b,c,jsfeat.U8C1_t);jsfeat.imgproc.grayscale(f.data,b,c,g);var h={blur_radius:4,low_threshold:50,high_threshold:0},i=0|h.blur_radius,j=i+1<<1;jsfeat.imgproc.gaussian_blur(g,g,j,0),jsfeat.imgproc.canny(g,g,h.low_threshold,h.high_threshold);for(var k=0,l=0;l<f.data.length;l+=4,k++)pix=g.data[k],f.data[l]=pix,f.data[l+1]=pix,f.data[l+2]=pix,f.data[l+3]=255;return e.putImageData(f,0,0),d}function b(a){switch(a){case"IDCard":return{width:950,height:566};case"HealthInsuranceCard":return{width:1004,height:637};case"DrivingLicense":return{width:1003,height:708};case"DrivingLicenseOld":return{width:1003,height:708};case"VehicleLicenseMotor":return{width:791,height:1098};case"VehicleLicenseCar":return{width:1712,height:1198};default:return alert("card type ({0}) not define".format(a)),{width:400,height:300}}}return{KeystoneCorrectionViewCtrl:function(a){this.InitialCanvas=function(a){d=document.createElement("canvas"),e=d.getContext("2d"),f=document.createElement("canvas"),g=f.getContext("2d");var i=b.width,j=b.height;f.width=i,f.height=j,d.width=i,d.height=j,h=[[10,10],[b.width-10,10],[b.width-10,b.height-10],[10,b.height-10]],e.drawImage(a,0,0,d.width,d.height),o(g,h),m(c,e,g),console.log("canvas initial")},this.GetPoints=function(){return h},this.GetScalePoints=function(a){var c=a.width/b.width,d=a.height/b.height,e=h,f=[[e[0][0]*c,e[0][1]*d],[e[1][0]*c,e[1][1]*d],[e[2][0]*c,e[2][1]*d],[e[3][0]*c,e[3][1]*d]];return f},this.SetScalePoints=function(a,d){var f=d.width/b.width,i=d.height/b.height,j=[[a[0][0]/f,a[0][1]/i],[a[1][0]/f,a[1][1]/i],[a[2][0]/f,a[2][1]/i],[a[3][0]/f,a[3][1]/i]];h=j,o(g,h),m(c,e,g)};var d,e,f,g,h,b=document.getElementById(a),c=b.getContext("2d"),i=Math.min(b.width,b.height),j=.1*i,k=function(a){var b=a.target.getBoundingClientRect();return{x:a.clientX-b.left,y:a.clientY-b.top}},l=function(a){var b=a.target.getBoundingClientRect();return{x:a.touches[0].pageX-(b.left+window.scrollX),y:a.touches[0].pageY-(b.top+window.scrollY)}},m=function(a,b,c){a.clearRect(0,0,a.canvas.width,a.canvas.height),a.drawImage(b.canvas,0,0),a.drawImage(c.canvas,0,0)},n=function(a,b,c){var d=b[0]-a[0],e=b[1]-a[1],f=e/d,g={x:0,y:0};if(0==e)g.y=a[1],g.x=d>0?a[0]+c:a[0]-c;else if(0==d)g.x=a[0],g.y=e>0?a[1]+c:a[1]-c;else{var h=Math.sqrt(Math.pow(c,2)/(1+Math.pow(f,2)));g.x=h+a[0],g.y=f*(g.x-a[0])+a[1],Math.min(a[0],b[0])<=g.x&&g.x<=Math.max(a[0],b[0])&&Math.min(a[1],b[1])<=g.y&&g.y<=Math.max(a[1],b[1])||(g.x=-1*h+a[0],g.y=f*(g.x-a[0])+a[1]),g.x=.001*Math.round(1e3*g.x),g.y=.001*Math.round(1e3*g.y)}return g},o=function(a,b){a.save(),a.clearRect(0,0,a.canvas.width,a.canvas.height);for(var c=["#ff0000","#00ff00","#eaff00","#0000ff"],d=0;d<4;d++){a.beginPath();var e=a.globalAlpha;a.globalAlpha=.2,a.fillStyle=c[d],a.arc(b[d][0],b[d][1],j,0,2*Math.PI),a.fill(),a.globalAlpha=e}for(var d=0;d<4;d++){a.save(),a.beginPath(),a.lineWidth="4",a.strokeStyle=c[d],a.moveTo(b[d][0]*p,b[d][1]*p);var f=n(b[d],b[(d+1)%4],Math.floor(20/p));a.lineTo(f.x*p,f.y*p),a.closePath(),a.stroke(),a.beginPath(),a.lineWidth="2",a.strokeStyle="#ff0000";var f=n([f.x,f.y],b[(d+1)%4],Math.floor(1/p));a.moveTo(f.x*p,f.y*p),f=n(b[(d+1)%4],b[d],Math.floor(20/p)),a.lineTo(f.x*p,f.y*p),a.closePath(),a.stroke(),a.restore(),a.beginPath(),a.lineWidth="4",a.strokeStyle=c[(d+1)%4],a.moveTo(f.x*p,f.y*p),a.lineTo(b[(d+1)%4][0]*p,b[(d+1)%4][1]*p),a.closePath(),a.stroke(),a.restore()}},p=1,q=null,r=null,s=null,t=function(a){for(var b=0;b<4;b++){var c=h[b][0]*p,d=h[b][1]*p;if(Math.pow(Math.pow(c-a.x,2)+Math.pow(d-a.y,2),.5)<=2*j){q=b,r=a,s=[c,d];break}}},u=function(){null!=q&&(c.clearRect(0,0,b.width,b.height),o(g,h),m(c,e,g),q=null)},v=function(a){if(null!=q){var d=a.x-r.x,f=a.y-r.y;h[q][0]=s[0]+d,h[q][1]=s[1]+f;var i=h[q][0],j=h[q][1];i<0&&(h[q][0]=0),j<0&&(h[q][1]=0),i>=b.width&&(h[q][0]=b.width-1),j>=b.height&&(h[q][1]=b.height-1),c.clearRect(0,0,b.width,b.height),o(g,h),m(c,e,g)}};b.addEventListener("mousedown",function(a){console.log("on canvas mousedown"),a.preventDefault();var b=k(a);t(b)}),b.addEventListener("mousemove",function(a){console.log("on canvas mousemove"),a.preventDefault();var b=k(a);v(b)}),b.addEventListener("mouseup",function(a){console.log("on canvas mouseup"),a.preventDefault(),u()}),b.addEventListener("touchstart",function(a){console.log("on canvas touchstart"),a.preventDefault();var b=l(a);t(b)},!1),b.addEventListener("touchcancel",function(a){console.log("on canvas touchcancel"),a.preventDefault(),u()},!1),b.addEventListener("touchmove",function(a){console.log("on canvas touchmove"),a.preventDefault();var b=l(a);v(b)},!1),b.addEventListener("touchend",function(a){console.log("on canvas touchend"),a.preventDefault(),u()},!1)},PerspectiveTransform:function(a,c,d){try{var e=fx.canvas()}catch(f){return alert(f),null}var g=[c[0][0],c[0][1],c[1][0],c[1][1],c[2][0],c[2][1],c[3][0],c[3][1]],h=e.texture(a),i=a.width,j=a.height,k=[0,0,i,0,i,j,0,j];e.draw(h).perspective(g,k).update();var l="org image\u53c3\u6578:\r\n"+"width/height: {0}, {1}\r\n".format(a.width,a.height),m="canvasPers\u53c3\u6578\r\n"+"width/height: {0}, {1}\r\n".format(e.width,e.height);console.log(l),console.log(m);var n="T\u578b\u6821\u6b63\u5ea7\u6a19(before):\r\n"+"\u5de6\u4e0a: x={0}, y={1}\r\n".format(g[0],g[1])+"\u53f3\u4e0a: x={0}, y={1}\r\n".format(g[2],g[3])+"\u53f3\u4e0b: x={0}, y={1}\r\n".format(g[4],g[5])+"\u5de6\u4e0b: x={0}, y={1}\r\n".format(g[6],g[7]),o="T\u578b\u6821\u6b63\u5ea7\u6a19(after):\r\n"+"\u5de6\u4e0a: x={0}, y={1}\r\n".format(k[0],k[1])+"\u53f3\u4e0a: x={0}, y={1}\r\n".format(k[2],k[3])+"\u53f3\u4e0b: x={0}, y={1}\r\n".format(k[4],k[5])+"\u5de6\u4e0b: x={0}, y={1}\r\n".format(k[6],k[7]);console.log(n),console.log(o),console.log("image perspective transform end");var p=b(d),q=document.createElement("canvas");q.width=p.width,q.height=p.height;var r=q.getContext("2d");return r.drawImage(e,0,0,q.width,q.height),q},CardEdgeDetection:function(b){var c=document.createElement("canvas"),d=950/b.width;c.width=b.width*d,c.height=b.height*d;var e=c.getContext("2d");e.mozImageSmoothingEnabled=!0,e.webkitImageSmoothingEnabled=!0,e.msImageSmoothingEnabled=!0,e.imageSmoothingEnabled=!0,e.drawImage(b,0,0,c.width,c.height);var f=510,g=Math.floor(.22*f),h=a(c),i=getLocatePoints(h,g);console.log("T\u578b\u6821\u6b63\u5ea7\u6a19(on Canvas):\r\n"+"\u5de6\u4e0a: x={0}, y={1}\r\n".format(i[0].x,i[0].y)+"\u53f3\u4e0a: x={0}, y={1}\r\n".format(i[2].x,i[2].y)+"\u53f3\u4e0b: x={0}, y={1}\r\n".format(i[3].x,i[3].y)+"\u5de6\u4e0b: x={0}, y={1}\r\n".format(i[1].x,i[1].y));var j=[[i[0].x/d,i[0].y/d],[i[2].x/d,i[2].y/d],[i[3].x/d,i[3].y/d],[i[1].x/d,i[1].y/d]];return j},ResizeImage:function(a,b){var c=document.createElement("canvas"),d=a.width*b,e=a.height*b;c.width=d,c.height=e;var f=c.getContext("2d");return b<.7&&(f.mozImageSmoothingEnabled=!0,f.webkitImageSmoothingEnabled=!0,f.msImageSmoothingEnabled=!0,f.imageSmoothingEnabled=!0),f.drawImage(a,0,0,d,e),c},ConvertToImage:function(a,b){if("png"!==b&&"webp"!==b&&"jpeg"!==b)return alert("\u4e0d\u652f\u63f4\u7684\u58d3\u7e2e\u683c\u5f0f\uff1a({0})".format(b)),null;var c="image/"+b,d=document.createElement("canvas");d.width=a.width,d.height=a.height;var f=(d.getContext("2d").drawImage(a,0,0),d.toDataURL(c,80)),g=new Image;return g.src=f,g.width=g.naturalWidth=a.width,g.height=g.naturalHeight=a.height,g},RotateImage:function(a,b){var c=a.width,d=a.height,e=a.getContext("2d").getImageData(0,0,c,d),f=0,g=0,h=0,i=0,j=0,k=0,l=e.data,m=document.createElement("canvas");if(180==b||-180==b){j=c,k=d,m.width=j,m.height=k;var n=m.getContext("2d").getImageData(0,0,j,k);pNewBuff=n.data;var o=0,p=0;for(g=0;g<d;g++)for(o=4*c*g,p=4*c*(d-g-1),f=0;f<c;f++)h=o+4*f,i=p+4*(c-1-f),pNewBuff[i]=l[h],pNewBuff[i+1]=l[h+1],pNewBuff[i+2]=l[h+2],pNewBuff[i+3]=l[h+3]}else if(90==b||-270==b){j=d,k=c,m.width=j,m.height=k;var n=m.getContext("2d").getImageData(0,0,j,k);pNewBuff=n.data;var q=4*c,r=4*j;for(g=0;g<d;g++)for(f=0;f<c;f++)h=g*q+4*f,i=f*r+4*(j-g-1),pNewBuff[i]=l[h],pNewBuff[i+1]=l[h+1],pNewBuff[i+2]=l[h+2],pNewBuff[i+3]=l[h+3]}else{if(270!=b&&-90!=b)return void alert("\u4e0d\u652f\u63f4\u7684\u65cb\u8f49\u89d2\u5ea6\uff1a{0}".format(b));j=d,k=c,m.width=j,m.height=k;var n=m.getContext("2d").getImageData(0,0,j,k);pNewBuff=n.data;var q=4*c,r=4*j;for(g=0;g<d;g++)for(f=0;f<c;f++)h=g*q+4*f,i=(k-f-1)*r+4*g,pNewBuff[i]=l[h],pNewBuff[i+1]=l[h+1],pNewBuff[i+2]=l[h+2],pNewBuff[i+3]=l[h+3]}return m.getContext("2d").putImageData(n,0,0),m}}}();
